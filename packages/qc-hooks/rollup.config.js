// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ“¦ Rollup é…ç½® - ä¸“ä¸šçš„åº“æ‰“åŒ…å·¥å…·
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

/**
 * ğŸ¯ ä¸ºä»€ä¹ˆç”¨ Rollupï¼Ÿ
 *
 * Rollup æ˜¯ä¸“ä¸ºåº“ï¼ˆlibrariesï¼‰è®¾è®¡çš„æ‰“åŒ…å·¥å…·ï¼Œç›¸æ¯” Webpack å’Œ Viteï¼š
 * âœ… æ›´å°çš„äº§ç‰©ä½“ç§¯ï¼ˆtree-shaking æ›´æ¿€è¿›ï¼‰
 * âœ… æ›´æ¸…æ™°çš„è¾“å‡ºä»£ç ï¼ˆæ¥è¿‘æ‰‹å†™ï¼‰
 * âœ… å¯¹ ES æ¨¡å—çš„åŸç”Ÿæ”¯æŒ
 * âœ… è¢«å¤§é‡çŸ¥ååº“ä½¿ç”¨ï¼ˆReactã€Vueã€Lodash ç­‰ï¼‰
 *
 * Vite åº•å±‚ä¹Ÿæ˜¯ç”¨ Rollupï¼Œä½† Vite ä¸»è¦é¢å‘åº”ç”¨å¼€å‘
 */

import resolve from '@rollup/plugin-node-resolve';
import typescript from '@rollup/plugin-typescript';
import peerDepsExternal from 'rollup-plugin-peer-deps-external';

export default {
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // ğŸ“¥ å…¥å£æ–‡ä»¶
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  /**
   * input: æ‰“åŒ…çš„å…¥å£æ–‡ä»¶
   *
   * ğŸ“– è¯´æ˜ï¼š
   * - Rollup ä»è¿™ä¸ªæ–‡ä»¶å¼€å§‹ï¼Œæ²¿ç€ import é“¾æ‰¾åˆ°æ‰€æœ‰ä¾èµ–
   * - å¯ä»¥æ˜¯å•ä¸ªæ–‡ä»¶ï¼ˆå­—ç¬¦ä¸²ï¼‰æˆ–å¤šä¸ªæ–‡ä»¶ï¼ˆæ•°ç»„/å¯¹è±¡ï¼‰
   *
   * ğŸ“š ç¤ºä¾‹ï¼š
   * input: 'src/index.ts'              // å•å…¥å£
   * input: ['src/a.ts', 'src/b.ts']    // å¤šå…¥å£ï¼ˆæ•°ç»„ï¼‰
   * input: { main: 'src/index.ts' }    // å¤šå…¥å£ï¼ˆå¯¹è±¡ï¼‰
   */
  input: 'src/index.ts',

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // ğŸ“¤ è¾“å‡ºé…ç½®
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  /**
   * output: å®šä¹‰æ‰“åŒ…åçš„è¾“å‡ºæ–‡ä»¶
   *
   * ğŸ” å¸¸è§æ ¼å¼ï¼ˆformatï¼‰ï¼š
   * - 'es' (ESM): import/export è¯­æ³•ï¼Œç°ä»£æµè§ˆå™¨å’Œæ‰“åŒ…å·¥å…·æ”¯æŒ
   * - 'cjs' (CommonJS): require/module.exportsï¼ŒNode.js ç¯å¢ƒ
   * - 'umd' (UMD): é€šç”¨æ¨¡å—ï¼ŒåŒæ—¶æ”¯æŒæµè§ˆå™¨ <script> å’Œ CommonJS/AMD
   * - 'iife': ç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œæµè§ˆå™¨ <script> æ ‡ç­¾
   *
   * ğŸ’¡ åº“æ¨èï¼š
   * - çº¯å‰ç«¯åº“ï¼šåªè¾“å‡º 'es' æ ¼å¼ï¼ˆç°ä»£åŒ–ï¼‰
   * - Node.js åº“ï¼šè¾“å‡º 'es' + 'cjs'
   * - æµè§ˆå™¨ç›´æ¥ä½¿ç”¨ï¼šè¾“å‡º 'umd' æˆ– 'iife'
   */
  output: [
    {
      /**
       * dir: è¾“å‡ºç›®å½•
       *
       * âš ï¸ é‡è¦ï¼š
       * - å½“ä½¿ç”¨ preserveModules: true æ—¶ï¼Œå¿…é¡»ç”¨ dir è€Œä¸æ˜¯ file
       * - å› ä¸ºä¼šè¾“å‡ºå¤šä¸ªæ–‡ä»¶ï¼Œä¸èƒ½æŒ‡å®šå•ä¸ªæ–‡ä»¶å
       *
       * file vs dir:
       * - file: 'dist/index.js'  â†’ å•æ–‡ä»¶è¾“å‡ºï¼ˆä¸ä¿ç•™æ¨¡å—ç»“æ„ï¼‰
       * - dir: 'dist'            â†’ å¤šæ–‡ä»¶è¾“å‡ºï¼ˆä¿ç•™æ¨¡å—ç»“æ„ï¼‰
       */
      dir: 'dist',

      /**
       * format: è¾“å‡ºæ ¼å¼
       *
       * é€‰æ‹© 'es' çš„åŸå› ï¼š
       * - ç°ä»£æ‰“åŒ…å·¥å…·ï¼ˆWebpackã€Viteã€Rollupï¼‰éƒ½æ”¯æŒ
       * - å¤©ç„¶æ”¯æŒ tree-shakingï¼ˆæ‘‡æ ‘ä¼˜åŒ–ï¼‰
       * - æœ€æ¥è¿‘ ESM æ ‡å‡†
       */
      format: 'es',

      /**
       * sourcemap: ç”Ÿæˆæºç æ˜ å°„æ–‡ä»¶
       *
       * ğŸ“– ä½œç”¨ï¼š
       * - è°ƒè¯•æ—¶èƒ½çœ‹åˆ°åŸå§‹ TypeScript ä»£ç 
       * - æµè§ˆå™¨ DevTools ä¼šè‡ªåŠ¨åŠ è½½ .map æ–‡ä»¶
       *
       * ğŸ’¡ é€‰é¡¹ï¼š
       * - true: ç”Ÿæˆç‹¬ç«‹çš„ .js.map æ–‡ä»¶
       * - 'inline': å°† sourcemap åµŒå…¥ JS æ–‡ä»¶
       * - false: ä¸ç”Ÿæˆ
       */
      sourcemap: true,

      /**
       * preserveModules: ä¿ç•™æ¨¡å—ç»“æ„
       *
       * ğŸ¯ é‡è¦æ¦‚å¿µï¼
       *
       * preserveModules: false (é»˜è®¤)
       * â”œâ”€â”€ dist/
       * â”‚   â””â”€â”€ index.es.js  (æ‰€æœ‰ä»£ç æ‰“åŒ…æˆä¸€ä¸ªæ–‡ä»¶)
       *
       * preserveModules: true
       * â”œâ”€â”€ dist/
       * â”‚   â”œâ”€â”€ index.js
       * â”‚   â”œâ”€â”€ hooks/
       * â”‚   â”‚   â””â”€â”€ useImmer.js
       * â”‚   â””â”€â”€ examples/
       * â”‚       â””â”€â”€ useImmer.example.js
       *
       * âœ… å¥½å¤„ï¼š
       * - æ›´å¥½çš„ tree-shakingï¼ˆç”¨æˆ·åªå¯¼å…¥éœ€è¦çš„æ¨¡å—ï¼‰
       * - æ›´æ¸…æ™°çš„ä»£ç ç»“æ„
       * - ç¬¦åˆ ESM è§„èŒƒ
       *
       * âš ï¸ æ³¨æ„ï¼š
       * - åªå¯¹ 'es' æ ¼å¼æœ‰æ„ä¹‰
       * - ä¼šç”Ÿæˆå¤šä¸ªæ–‡ä»¶
       */
      preserveModules: true,

      /**
       * preserveModulesRoot: ä¿ç•™æ¨¡å—çš„æ ¹ç›®å½•
       *
       * ğŸ“– è¯´æ˜ï¼š
       * æŒ‡å®šæºç çš„æ ¹ç›®å½•ï¼Œå½±å“è¾“å‡ºçš„ç›®å½•ç»“æ„
       *
       * ä¸è®¾ç½®æ—¶ï¼š
       * src/hooks/useImmer.ts â†’ dist/src/hooks/useImmer.js
       *
       * è®¾ç½®ä¸º 'src'ï¼š
       * src/hooks/useImmer.ts â†’ dist/hooks/useImmer.js
       *
       * âœ… æ¨èè®¾ç½®ï¼Œè®©è¾“å‡ºç»“æ„æ›´ç®€æ´
       */
      preserveModulesRoot: 'src',
    },
  ],

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // ğŸ”Œ æ’ä»¶é…ç½®
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  /**
   * plugins: Rollup æ’ä»¶æ•°ç»„
   *
   * ğŸ“– æ‰§è¡Œé¡ºåºï¼š
   * æ’ä»¶æŒ‰æ•°ç»„é¡ºåºæ‰§è¡Œï¼Œé¡ºåºå¾ˆé‡è¦ï¼
   * ä¸€èˆ¬è§„åˆ™ï¼šå¤–éƒ¨åŒ– â†’ è§£æ â†’ è½¬æ¢ â†’ å‹ç¼©
   */
  plugins: [
    /**
     * 1ï¸âƒ£ peerDepsExternal - è‡ªåŠ¨å¤–éƒ¨åŒ– peerDependencies
     *
     * ğŸ¯ ä½œç”¨ï¼š
     * è¯»å– package.json çš„ peerDependencies å­—æ®µ
     * è‡ªåŠ¨å°†è¿™äº›ä¾èµ–æ ‡è®°ä¸º externalï¼Œä¸æ‰“åŒ…è¿›äº§ç‰©
     *
     * ğŸ“– ç¤ºä¾‹ï¼š
     * package.json ä¸­æœ‰ï¼š
     * "peerDependencies": {
     *   "react": "^18.0.0",
     *   "immer": "^11.0.0"
     * }
     *
     * è¿™ä¸ªæ’ä»¶ä¼šè‡ªåŠ¨å¤„ç†ï¼Œç­‰ä»·äºï¼š
     * external: ['react', 'immer']
     *
     * âœ… å¥½å¤„ï¼š
     * - é¿å…é‡å¤æ‰“åŒ…ï¼ˆç”¨æˆ·é¡¹ç›®å·²æœ‰è¿™äº›ä¾èµ–ï¼‰
     * - å‡å°äº§ç‰©ä½“ç§¯
     * - ä¿è¯ç‰ˆæœ¬ä¸€è‡´æ€§
     */
    peerDepsExternal(),

    /**
     * 2ï¸âƒ£ resolve - è§£æ node_modules ä¸­çš„ä¾èµ–
     *
     * ğŸ¯ ä½œç”¨ï¼š
     * Rollup é»˜è®¤åªå¤„ç†ç›¸å¯¹è·¯å¾„çš„å¯¼å…¥
     * è¿™ä¸ªæ’ä»¶è®© Rollup èƒ½æ‰¾åˆ° node_modules ä¸­çš„åŒ…
     *
     * ğŸ“– ç¤ºä¾‹ï¼š
     * æ²¡æœ‰è¿™ä¸ªæ’ä»¶ï¼š
     * import { produce } from 'immer';  // âŒ æ‰¾ä¸åˆ°
     *
     * æœ‰è¿™ä¸ªæ’ä»¶ï¼š
     * import { produce } from 'immer';  // âœ… èƒ½æ­£ç¡®è§£æ
     *
     * ğŸ’¡ é…ç½®é€‰é¡¹ï¼š
     * resolve({
     *   extensions: ['.js', '.ts'],  // è§£æçš„æ–‡ä»¶æ‰©å±•å
     *   browser: true,               // ä¼˜å…ˆä½¿ç”¨ browser å­—æ®µ
     * })
     */
    resolve(),

    /**
     * 3ï¸âƒ£ typescript - å¤„ç† TypeScript æ–‡ä»¶
     *
     * ğŸ¯ ä½œç”¨ï¼š
     * - å°† .ts/.tsx ç¼–è¯‘ä¸º JavaScript
     * - ç”Ÿæˆç±»å‹å£°æ˜æ–‡ä»¶ (.d.ts)
     *
     * ğŸ“– é…ç½®è¯´æ˜ï¼š
     */
    typescript({
      /**
       * declaration: ç”Ÿæˆ .d.ts ç±»å‹å£°æ˜æ–‡ä»¶
       *
       * true: ç”Ÿæˆç±»å‹æ–‡ä»¶
       * false: ä¸ç”Ÿæˆï¼ˆä¸æ¨èï¼‰
       */
      declaration: true,

      /**
       * declarationDir: ç±»å‹æ–‡ä»¶è¾“å‡ºç›®å½•
       *
       * æŒ‡å®š .d.ts æ–‡ä»¶çš„è¾“å‡ºä½ç½®
       * é€šå¸¸å’Œ JS æ–‡ä»¶æ”¾åœ¨åŒä¸€ä¸ª dist ç›®å½•
       */
      declarationDir: 'dist',

      /**
       * exclude: æ’é™¤ä¸éœ€è¦ç¼–è¯‘çš„æ–‡ä»¶
       *
       * ğŸ“– ä½¿ç”¨åœºæ™¯ï¼š
       * - æ’é™¤æµ‹è¯•æ–‡ä»¶: '**\/*.test.ts'
       * - æ’é™¤ç¤ºä¾‹æ–‡ä»¶: 'src/examples/**'
       * - æ’é™¤é…ç½®æ–‡ä»¶: '**\/*.config.ts'
       *
       * ğŸ’¡ æ”¯æŒ glob æ¨¡å¼
       */
      exclude: ['src/examples/**'],

      /**
       * å…¶ä»–å¸¸ç”¨é€‰é¡¹ï¼š
       *
       * tsconfig: './tsconfig.json'  // æŒ‡å®š tsconfig æ–‡ä»¶
       * sourceMap: true               // ç”Ÿæˆ sourcemap
       * noEmitOnError: true           // ç±»å‹é”™è¯¯æ—¶åœæ­¢æ„å»º
       */
    }),
  ],

  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  // ğŸš« å¤–éƒ¨ä¾èµ–é…ç½®
  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  /**
   * external: å¤–éƒ¨ä¾èµ–åˆ—è¡¨
   *
   * ğŸ¯ ä½œç”¨ï¼š
   * å‘Šè¯‰ Rollup å“ªäº›æ¨¡å—ä¸è¦æ‰“åŒ…ï¼Œä¿ç•™ import è¯­å¥
   *
   * ğŸ“– ç¤ºä¾‹ï¼š
   * æºç ï¼š
   * import { useState } from 'react';
   *
   * external: ['react'] åçš„è¾“å‡ºï¼š
   * import { useState } from 'react';  // âœ… ä¿ç•™ import
   *
   * æ²¡æœ‰ external çš„è¾“å‡ºï¼š
   * // âŒ ä¼šå°è¯•æ‰“åŒ…æ•´ä¸ª React æºç 
   *
   * ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ
   * 1. é¿å…é‡å¤æ‰“åŒ…
   *    ç”¨æˆ·é¡¹ç›®å·²ç»å®‰è£…äº† Reactï¼Œä¸éœ€è¦å†æ‰“åŒ…ä¸€ä»½
   *
   * 2. ä¿è¯ç‰ˆæœ¬ä¸€è‡´
   *    ç”¨æˆ·ä½¿ç”¨è‡ªå·±å®‰è£…çš„ React ç‰ˆæœ¬
   *
   * 3. å‡å°ä½“ç§¯
   *    React æœ¬èº«å¾ˆå¤§ï¼Œä¸åº”è¯¥æ‰“åŒ…è¿›åº“
   *
   * ğŸ” åŒ¹é…è§„åˆ™ï¼š
   * external: ['react']              // ç²¾ç¡®åŒ¹é…
   * external: [/^react/]             // æ­£åˆ™åŒ¹é…ï¼ˆåŒ¹é… react-dom ç­‰ï¼‰
   * external: (id) => id.includes()  // å‡½æ•°åˆ¤æ–­
   *
   * âš ï¸ æ³¨æ„ï¼š
   * peerDepsExternal æ’ä»¶å·²ç»è‡ªåŠ¨å¤„ç†äº†å¤§éƒ¨åˆ†æƒ…å†µ
   * è¿™é‡Œæ˜¾å¼å£°æ˜æ˜¯ä¸ºäº†é¢å¤–ä¿é™©
   */
  external: [
    'react',
    'react-dom',
    'react/jsx-runtime', // React 17+ çš„ JSX è¿è¡Œæ—¶
    'immer',
  ],
};

/**
 * ğŸ“š æ€»ç»“ï¼šRollup é…ç½®çš„æ ¸å¿ƒæ¦‚å¿µ
 *
 * 1. å…¥å£ï¼ˆinputï¼‰â†’ æ’ä»¶å¤„ç† â†’ è¾“å‡ºï¼ˆoutputï¼‰
 *
 * 2. å¤–éƒ¨åŒ–ï¼ˆexternalï¼‰å¾ˆé‡è¦
 *    - peerDependencies åº”è¯¥å¤–éƒ¨åŒ–
 *    - è¿è¡Œæ—¶ä¾èµ–å¯ä»¥æ‰“åŒ…æˆ–å¤–éƒ¨åŒ–ï¼ˆçœ‹æƒ…å†µï¼‰
 *
 * 3. preserveModules æå‡ tree-shaking
 *    - å¯¹åº“æ¥è¯´æ˜¯æœ€ä½³å®è·µ
 *    - è®©ç”¨æˆ·åªåŠ è½½éœ€è¦çš„éƒ¨åˆ†
 *
 * 4. sourcemap å¸®åŠ©è°ƒè¯•
 *    - å¼€å‘ä½“éªŒæ›´å¥½
 *    - ç”Ÿäº§ç¯å¢ƒä¹Ÿå»ºè®®ä¿ç•™
 *
 * 5. TypeScript æ’ä»¶è´Ÿè´£ç±»å‹
 *    - ç”Ÿæˆ .d.ts ä¾›ç”¨æˆ·ä½¿ç”¨
 *    - ä¿è¯ç±»å‹å®‰å…¨
 */
