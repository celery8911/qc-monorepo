# CI 持续集成工作流
# 作用：每次 PR 和 push 到 main 时自动运行构建和测试
name: CI

# 触发条件
on:
  pull_request:
    branches: [main]  # 当有 PR 指向 main 分支时触发
  push:
    branches: [main]  # 当代码推送到 main 分支时触发

jobs:
  # 定义一个名为 build 的任务
  build:
    name: Build and Test  # 任务显示名称
    runs-on: ubuntu-latest  # 运行环境：Ubuntu 最新版

    steps:
      # 步骤1: 检出代码
      - name: Checkout
        uses: actions/checkout@v4  # 使用 GitHub 官方 action 拉取代码

      # 步骤2: 安装 pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2  # pnpm 官方 action
        with:
          version: 8.6.2  # 指定 pnpm 版本，与 package.json 中保持一致

      # 步骤3: 安装 Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20  # 使用 Node.js 20
          cache: 'pnpm'  # 启用 pnpm 缓存，加速依赖安装

      # 步骤4: 安装项目依赖
      - name: Install dependencies
        run: pnpm install  # 安装 package.json 中的所有依赖

      # 步骤5: 构建所有包
      - name: Build packages
        run: pnpm build  # 执行 Turborepo 构建命令

      # 步骤6: 运行测试（如果有）
      - name: Run tests
        run: pnpm test --if-present  # --if-present: 如果没有 test 脚本也不报错
